<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animal Pop Adventure</title>

<style>
:root{
--bg:#06141b;
--panel:#0d2230;
--accent:#00e5ff;
--pink:#ff2ea6;
}

body{
margin:0;
background:radial-gradient(circle at 30% 10%,#0b2a38,#02070a 70%);
font-family:Segoe UI;
color:white;
display:flex;
justify-content:center;
}

#game-container{
width:420px;
height:680px;
background:var(--panel);
border-radius:20px;
box-shadow:0 0 40px #00e5ff33;
overflow:hidden;
margin-top:20px;
}

/* MAPA */
#map-screen{
padding:20px;
display:grid;
grid-template-columns:repeat(4,1fr);
gap:15px;
overflow-y:auto;
height:100%;
}

.level-node{
width:60px;height:60px;
border-radius:50%;
display:flex;align-items:center;justify-content:center;
background:#123648;
border:3px solid var(--accent);
cursor:pointer;
font-weight:bold;
}

.locked{
opacity:.35;
cursor:not-allowed;
border-color:#555;
}

/* GAME */
#game-screen{display:none;flex-direction:column;height:100%}

.header{
display:flex;
justify-content:space-around;
padding:14px;
background:#0c2a3b;
}

#grid{
display:grid;
grid-template-columns:repeat(8,48px);
grid-template-rows:repeat(8,48px);
gap:3px;
margin:12px auto;
}

.cell{
background:#08212c;
display:flex;
align-items:center;
justify-content:center;
font-size:26px;
border-radius:10px;
cursor:pointer;
transition:.15s;
}

.cell.selected{outline:3px solid var(--pink)}

.btn{
margin:10px auto;
padding:10px 18px;
background:linear-gradient(90deg,#00e5ff,#ff2ea6);
border:none;
border-radius:18px;
color:white;
cursor:pointer;
}
</style>
</head>

<body>

<div id="game-container">

<div id="map-screen"></div>

<div id="game-screen">
<div class="header">
<div id="level-display"></div>
<div id="score-display"></div>
<div id="target-display"></div>
</div>

<div id="grid"></div>
<button class="btn" onclick="goToMap()">Volver al mapa</button>
</div>

</div>

<script>
const animals=["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº"];
const SIZE=8;

let level=1;
let score=0;
let target=0;
let unlocked=parseInt(localStorage.getItem("animalpop")||1);

let grid=[];
let selected=null;

const map=document.getElementById("map-screen");
const game=document.getElementById("game-screen");
const gridEl=document.getElementById("grid");

/* ===== MAPA ===== */
function initMap(){
map.innerHTML="";
for(let i=1;i<=20;i++){
const n=document.createElement("div");
n.className="level-node "+(i>unlocked?"locked":"");
n.textContent=i;
n.onclick=()=>{if(i<=unlocked)startLevel(i)};
map.appendChild(n);
}
}

/* ===== NIVEL ===== */
function startLevel(lvl){
level=lvl;
score=0;
target=lvl*300;

document.getElementById("level-display").textContent="Nivel "+lvl;
document.getElementById("score-display").textContent="0";
document.getElementById("target-display").textContent="Meta "+target;

map.style.display="none";
game.style.display="flex";

generateCleanGrid();
render();
}

/* ===== GRID SIN COMBOS INICIALES ===== */
function generateCleanGrid(){
grid=[];
for(let r=0;r<SIZE;r++){
grid[r]=[];
for(let c=0;c<SIZE;c++){
let val;
do{
val=randAnimal();
grid[r][c]=val;
}while(matchAt(r,c));
}
}
}

function randAnimal(){
return animals[Math.floor(Math.random()*animals.length)];
}

/* ===== RENDER ===== */
function render(){
gridEl.innerHTML="";
for(let r=0;r<SIZE;r++){
for(let c=0;c<SIZE;c++){
const d=document.createElement("div");
d.className="cell";
d.textContent=grid[r][c];
d.onclick=()=>clickCell(r,c,d);
gridEl.appendChild(d);
}
}
}

/* ===== CLICK ===== */
function clickCell(r,c,el){
if(!selected){
selected={r,c,el};
el.classList.add("selected");
return;
}

const dist=Math.abs(selected.r-r)+Math.abs(selected.c-c);
if(dist!==1){
selected.el.classList.remove("selected");
selected={r,c,el};
el.classList.add("selected");
return;
}

/* probar swap */
swap(selected.r,selected.c,r,c);

if(hasMatch()){
selected=null;
cascade();
}else{
swap(selected.r,selected.c,r,c);
}

render();
}

/* ===== LOGICA ===== */
function swap(r1,c1,r2,c2){
let t=grid[r1][c1];
grid[r1][c1]=grid[r2][c2];
grid[r2][c2]=t;
}

function matchAt(r,c){
const v=grid[r][c];
if(!v)return false;

return(
(c>1 && v===grid[r][c-1]&&v===grid[r][c-2])||
(r>1 && v===grid[r-1][c]&&v===grid[r-2][c])
);
}

function hasMatch(){
for(let r=0;r<SIZE;r++)
for(let c=0;c<SIZE;c++)
if(matchAt(r,c))return true;
return false;
}

/* ===== ELIMINAR + CAER ===== */
function cascade(){
let removed=false;

let mark=[...Array(SIZE)].map(()=>Array(SIZE).fill(false));

for(let r=0;r<SIZE;r++)
for(let c=0;c<SIZE;c++){
let v=grid[r][c];
if(!v)continue;

if(c<SIZE-2&&v===grid[r][c+1]&&v===grid[r][c+2])
mark[r][c]=mark[r][c+1]=mark[r][c+2]=true;

if(r<SIZE-2&&v===grid[r+1][c]&&v===grid[r+2][c])
mark[r][c]=mark[r+1][c]=mark[r+2][c]=true;
}

for(let r=0;r<SIZE;r++)
for(let c=0;c<SIZE;c++)
if(mark[r][c]){
grid[r][c]=null;
score+=10;
removed=true;
}

if(!removed){checkWin();return;}

document.getElementById("score-display").textContent=score;

/* gravedad */
for(let c=0;c<SIZE;c++){
let col=[];
for(let r=SIZE-1;r>=0;r--)if(grid[r][c])col.push(grid[r][c]);
for(let r=SIZE-1;r>=0;r--)grid[r][c]=col.shift()||randAnimal();
}

render();
setTimeout(cascade,200);
}

/* ===== WIN ===== */
function checkWin(){
if(score>=target){
alert("Nivel superado!");
if(level===unlocked){
unlocked++;
localStorage.setItem("animalpop",unlocked);
}
goToMap();
}
}

function goToMap(){
game.style.display="none";
map.style.display="grid";
initMap();
}

initMap();
</script>

</body>
</html>
