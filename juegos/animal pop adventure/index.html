<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzDi Animal Pop! - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        :root { --pink: #ff66b2; --blue: #4facfe; --bg-main: #124e66; --font: 'Luckiest Guy', cursive; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #222; font-family: var(--font); }
        
        #game-wrapper { width: 100%; max-width: 450px; height: 100%; margin: 0 auto; position: relative; background: var(--bg-main); overflow: hidden; }

        /* --- HEADER --- */
        .top-nav { height: 80px; display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.3); border-bottom: 4px solid var(--pink); color: white; }
        .stat { text-align: center; }
        .stat-val { font-size: 20px; display: block; color: var(--pink); }

        /* --- MAPA --- */
        #map-screen { position: absolute; inset: 0; overflow-y: auto; background: linear-gradient(#4facfe, #a8e063, #ffd700); z-index: 10; padding-top: 80px; }
        .level-node { position: absolute; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; background: radial-gradient(circle, #f7a52e, #d47a00); border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.4); transform: translateX(-50%); cursor: pointer; transition: 0.2s; }
        .level-node.locked { background: #666; filter: grayscale(1); opacity: 0.7; }

        /* --- TABLERO --- */
        #game-screen { display: none; position: absolute; inset: 0; background: radial-gradient(#2193b0, #6ddaff); z-index: 100; flex-direction: column; align-items: center; }
        .score-panel { margin-top: 40px; text-align: center; color: white; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        
        #grid-container { 
            background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(10px);
            padding: 10px; border-radius: 20px; border: 5px solid rgba(255,255,255,0.4);
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px;
            width: 95%; aspect-ratio: 1/1; margin: 20px 0;
        }

        .cell { 
            background: rgba(255,255,255,0.1); border-radius: 12px;
            display: flex; justify-content: center; align-items: center; font-size: 30px;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        
        /* ESPECIALES */
        .special-striped-h { border: 3px solid white; background: linear-gradient(0deg, rgba(255,255,255,0) 40%, white 50%, rgba(255,255,255,0) 60%); border-radius: 50%; }
        .special-striped-v { border: 3px solid white; background: linear-gradient(90deg, rgba(255,255,255,0) 40%, white 50%, rgba(255,255,255,0) 60%); border-radius: 50%; }
        .special-bomb { animation: bombPulse 0.5s infinite alternate; font-size: 38px; filter: drop-shadow(0 0 8px gold); }
        
        @keyframes bombPulse { from { transform: scale(1); } to { transform: scale(1.2); } }

        /* MODAL VICTORIA */
        #win-modal { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
        .win-box { background: white; width: 85%; padding: 40px 20px; border-radius: 40px; text-align: center; border: 10px solid var(--pink); }
        .win-box h1 { color: var(--pink); font-size: 40px; margin: 0; }
        .btn-win { background: #4caf50; color: white; padding: 15px 40px; border-radius: 50px; border: none; font-family: var(--font); font-size: 25px; margin-top: 20px; box-shadow: 0 6px 0 #2e7d32; }

        .moves-box { background: rgba(0,0,0,0.3); padding: 10px 30px; border-radius: 30px; color: white; font-size: 28px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div class="top-nav">
        <div class="stat">VIDAS<span class="stat-val" id="ui-lives">5</span></div>
        <div class="stat">MONEDAS<span class="stat-val" id="ui-coins">100</span></div>
        <button onclick="location.reload()" style="background:none; border:2px solid white; color:white; border-radius:10px; font-family:var(--font)">üè†</button>
    </div>

    <div id="map-screen">
        <div id="nodes-container" style="position:relative; width:100%; height:5000px;"></div>
    </div>

    <div id="game-screen">
        <div class="score-panel">
            <div style="font-size: 16px;">OBJETIVO: <span id="txt-target">0</span></div>
            <div style="font-size: 45px;">PUNTOS: <span id="txt-score">0</span></div>
        </div>

        <div id="grid-container"></div>

        <div style="display:flex; width:100%; justify-content:space-around; align-items:center;">
            <div class="moves-box">üéà <span id="txt-moves">25</span></div>
            <button onclick="exitGame()" style="background:#ff4d4d; border:none; padding:15px; border-radius:20px; color:white; font-family:var(--font);">SALIR</button>
        </div>
    </div>

    <div id="win-modal">
        <div class="win-box">
            <h1>¬°GENIAL!</h1>
            <p style="font-size:20px; color:#555">NIVEL COMPLETADO<br>üí∞ +50 MONEDAS</p>
            <button class="btn-win" onclick="nextLevel()">CONTINUAR</button>
        </div>
    </div>
</div>

<script>
    const EMOJIS = ['üê∂', 'üê±', 'üêπ', 'üê∞', 'ü¶ä', 'üêª'];
    let unlocked = parseInt(localStorage.getItem('az_un')) || 1;
    let coins = parseInt(localStorage.getItem('az_co')) || 100;
    let lives = parseInt(localStorage.getItem('az_li')) || 5;

    let grid = [], specials = []; 
    let selected = null, isBlocked = false;
    let score = 0, moves = 0, target = 0, curLvl = 0;

    function initMap() {
        const container = document.getElementById('nodes-container');
        container.innerHTML = '';
        const w = document.body.clientWidth;
        document.getElementById('ui-lives').innerText = lives;
        document.getElementById('ui-coins').innerText = coins;

        for (let i = 1; i <= 50; i++) {
            const btn = document.createElement('div');
            btn.className = `level-node ${i > unlocked ? 'locked' : ''}`;
            btn.innerText = i;
            btn.style.top = (4800 - (i * 140)) + 'px';
            btn.style.left = (w/2 + Math.sin(i * 0.7) * (w * 0.28)) + 'px';
            if (i <= unlocked) btn.onclick = () => startLevel(i);
            container.appendChild(btn);
        }
        document.getElementById('map-screen').scrollTop = 4800 - (unlocked * 140) - 350;
    }

    function startLevel(lvl) {
        if (lives <= 0) return alert("¬°Sin vidas!");
        curLvl = lvl; score = 0;
        moves = Math.max(15, 30 - Math.floor(lvl/5));
        target = 500 + (lvl * 400);
        
        document.getElementById('txt-score').innerText = score;
        document.getElementById('txt-target').innerText = target;
        document.getElementById('txt-moves').innerText = moves;
        document.getElementById('map-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        
        buildGrid();
    }

    function buildGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        grid = []; specials = [];
        for (let i = 0; i < 64; i++) {
            const animal = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            grid.push(animal);
            specials.push(null);
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.idx = i;
            cell.innerText = animal;
            cell.onclick = () => onCellClick(cell);
            container.appendChild(cell);
        }
        while(hasMatches()) { shuffle(); }
        refreshUI();
    }

    function onCellClick(cell) {
        if (isBlocked || moves <= 0) return;
        const idx = parseInt(cell.dataset.idx);

        if (!selected) {
            selected = cell;
            cell.style.transform = "scale(1.2)";
            cell.style.background = "white";
        } else {
            const idx1 = parseInt(selected.dataset.idx);
            const idx2 = idx;

            if (isAdjacent(idx1, idx2)) {
                swap(idx1, idx2);
                isBlocked = true;
                setTimeout(() => {
                    if (!processTurn()) {
                        swap(idx1, idx2); // Rebote si no hay match
                        isBlocked = false;
                    } else {
                        moves--;
                        document.getElementById('txt-moves').innerText = moves;
                    }
                }, 300);
            }
            selected.style.transform = "scale(1)";
            selected.style.background = "rgba(255,255,255,0.1)";
            selected = null;
        }
    }

    function processTurn() {
        let matches = getMatches();
        if (matches.length > 0) {
            handleSpecials(matches);
            removeAndFill(matches);
            return true;
        }
        return false;
    }

    function getMatches() {
        let matched = new Set();
        // Horiz
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 6; c++) {
                let i = r * 8 + c;
                if (grid[i] && grid[i] === grid[i+1] && grid[i] === grid[i+2]) {
                    matched.add(i); matched.add(i+1); matched.add(i+2);
                    if (c < 5 && grid[i] === grid[i+3]) { // Crear Striped
                        matched.add(i+3);
                        specials[i] = 'h-striped';
                    }
                }
            }
        }
        // Vert
        for (let c = 0; c < 8; c++) {
            for (let r = 0; r < 6; r++) {
                let i = r * 8 + c;
                if (grid[i] && grid[i] === grid[i+8] && grid[i] === grid[i+16]) {
                    matched.add(i); matched.add(i+8); matched.add(i+16);
                    if (r < 5 && grid[i] === grid[i+24]) { // Crear Bomb/Color
                        matched.add(i+24);
                        specials[i] = 'bomb';
                        grid[i] = 'üåà';
                    }
                }
            }
        }
        return Array.from(matched);
    }

    function handleSpecials(matches) {
        matches.forEach(id => {
            if (specials[id] === 'h-striped') {
                let row = Math.floor(id/8);
                for(let c=0; c<8; c++) matches.push(row*8+c);
            }
            if (specials[id] === 'bomb') {
                // Simula explosi√≥n de √°rea
                let neighbors = [id-1, id+1, id-8, id+8, id-7, id+7, id-9, id+9];
                neighbors.forEach(n => { if(n>=0 && n<64) matches.push(n); });
            }
        });
    }

    function removeAndFill(matches) {
        score += matches.length * 10;
        document.getElementById('txt-score').innerText = score;
        matches.forEach(id => { grid[id] = null; specials[id] = null; });
        refreshUI();

        setTimeout(() => {
            for (let c = 0; c < 8; c++) {
                for (let r = 7; r >= 0; r--) {
                    let i = r * 8 + c;
                    if (grid[i] === null) {
                        let k = r - 1;
                        while (k >= 0 && grid[k*8+c] === null) k--;
                        if (k >= 0) {
                            grid[i] = grid[k*8+c];
                            specials[i] = specials[k*8+c];
                            grid[k*8+c] = null;
                            specials[k*8+c] = null;
                        } else {
                            grid[i] = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
                        }
                    }
                }
            }
            refreshUI();
            setTimeout(() => {
                if (!processTurn()) {
                    isBlocked = false;
                    checkState();
                }
            }, 300);
        }, 300);
    }

    function checkState() {
        if (score >= target) {
            document.getElementById('win-modal').style.display = 'flex';
            coins += 50; unlocked = Math.max(unlocked, curLvl + 1);
            save();
        } else if (moves <= 0) {
            lives--; save();
            alert("¬°Se acabaron los movimientos! üò¢");
            exitGame();
        }
    }

    function refreshUI() {
        const cells = document.querySelectorAll('.cell');
        grid.forEach((val, i) => {
            cells[i].innerText = val || '';
            cells[i].className = 'cell';
            if (specials[i] === 'h-striped') cells[i].classList.add('special-striped-h');
            if (specials[i] === 'bomb') cells[i].classList.add('special-bomb');
            cells[i].style.opacity = val ? "1" : "0";
        });
    }

    function isAdjacent(a, b) {
        const r1 = Math.floor(a/8), r2 = Math.floor(b/8);
        const c1 = a%8, c2 = b%8;
        return (Math.abs(r1-r2) + Math.abs(c1-c2)) === 1;
    }

    function swap(i, j) {
        let t = grid[i]; grid[i] = grid[j]; grid[j] = t;
        let s = specials[i]; specials[i] = specials[j]; specials[j] = s;
        refreshUI();
    }

    function hasMatches() { return getMatches().length > 0; }
    function shuffle() { grid = grid.map(() => EMOJIS[Math.floor(Math.random()*EMOJIS.length)]); }
    function save() { localStorage.setItem('az_un', unlocked); localStorage.setItem('az_co', coins); localStorage.setItem('az_li', lives); }
    function exitGame() { document.getElementById('game-screen').style.display = 'none'; document.getElementById('map-screen').style.display = 'block'; initMap(); }
    function nextLevel() { document.getElementById('win-modal').style.display = 'none'; exitGame(); }

    window.onload = initMap;
</script>
</body>
</html>
