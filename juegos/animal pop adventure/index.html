<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AzDi Animal Pop | Adventure</title>

<style>
:root{
    --bg:#06141b;
    --panel:#0d2230;
    --accent:#00e5ff;
    --pink:#ff2ea6;
}

body{
    margin:0;
    background: radial-gradient(circle at 30% 10%,#0b2a38,#02070a 70%);
    font-family: 'Segoe UI', sans-serif;
    color:white;
    display:flex;
    justify-content:center;
    overflow: hidden;
}

#game-container{
    width:420px;
    height:720px;
    background:var(--panel);
    border-radius:20px;
    box-shadow:0 0 40px #00e5ff33;
    overflow:hidden;
    margin-top:20px;
    position: relative;
    border: 2px solid #ffffff11;
}

/* MAPA */
#map-screen{
    padding:20px;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:15px;
    overflow-y:auto;
    height:90%;
}

.level-node{
    width:65px; height:65px;
    border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    background:#123648;
    border:3px solid var(--accent);
    cursor:pointer;
    font-weight:bold;
    transition: 0.3s;
    box-shadow: 0 0 10px var(--accent);
}

.level-node:hover:not(.locked){ transform: scale(1.1); background: var(--accent); color: black; }

.locked{
    opacity:.3;
    cursor:not-allowed;
    border-color:#555;
    box-shadow: none;
}

/* GAME SCREEN */
#game-screen{ display:none; flex-direction:column; height:100%; }

.header{
    display:flex;
    justify-content:space-around;
    align-items: center;
    padding:20px;
    background: rgba(0,0,0,0.3);
    border-bottom: 2px solid var(--accent);
}

#grid{
    display:grid;
    grid-template-columns:repeat(8, 48px);
    grid-template-rows:repeat(8, 48px);
    gap:4px;
    margin:25px auto;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 12px;
}

.cell{
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.05);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
    border-radius:8px;
    cursor:pointer;
    transition: transform 0.1s, background 0.2s;
    user-select: none;
}

.cell:hover { background: rgba(255,255,255,0.1); }
.cell.selected{ outline:3px solid var(--pink); background: rgba(255, 46, 166, 0.2); transform: scale(1.05); }

.btn{
    margin: 10px auto;
    padding:12px 25px;
    background:linear-gradient(90deg,#00e5ff,#ff2ea6);
    border:none;
    border-radius:20px;
    color:white;
    font-weight: bold;
    cursor:pointer;
    text-transform: uppercase;
}
</style>
</head>

<body>

<div id="game-container">
    <div id="map-screen"></div>

    <div id="game-screen">
        <div class="header">
            <div id="level-display" style="color: var(--accent)"></div>
            <div id="score-display" style="font-weight: bold; font-size: 20px;"></div>
            <div id="target-display" style="color: var(--pink)"></div>
        </div>

        <div id="grid"></div>
        <button class="btn" onclick="goToMap()">Abandonar</button>
    </div>
</div>

<script>
const animals=["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº"];
const SIZE=8;

let level=1;
let score=0;
let target=0;
let unlocked=parseInt(localStorage.getItem("animalpop_save")||1);

let grid=[];
let selected=null;
let isAnimating = false;

const mapScreen = document.getElementById("map-screen");
const gameScreen = document.getElementById("game-screen");
const gridEl = document.getElementById("grid");

/* ===== MAPA ===== */
function initMap(){
    mapScreen.innerHTML = "";
    mapScreen.style.display = "grid";
    gameScreen.style.display = "none";
    
    for(let i=1; i<=20; i++){
        const n = document.createElement("div");
        n.className = "level-node " + (i > unlocked ? "locked" : "");
        n.textContent = i;
        n.onclick = () => { if(i <= unlocked) startLevel(i) };
        mapScreen.appendChild(n);
    }
}

/* ===== INICIAR NIVEL ===== */
function startLevel(lvl){
    level = lvl;
    score = 0;
    target = lvl * 250;
    isAnimating = false;

    document.getElementById("level-display").textContent = "Lvl " + lvl;
    document.getElementById("score-display").textContent = "0";
    document.getElementById("target-display").textContent = "Objetivo: " + target;

    mapScreen.style.display = "none";
    gameScreen.style.display = "flex";

    generateCleanGrid();
    render();
}

function generateCleanGrid(){
    grid = [];
    for(let r=0; r<SIZE; r++){
        grid[r] = [];
        for(let c=0; c<SIZE; c++){
            let val;
            do {
                val = animals[Math.floor(Math.random()*animals.length)];
                grid[r][c] = val;
            } while (checkImmediateMatch(r, c, val));
        }
    }
}

function checkImmediateMatch(r, c, val){
    if(c > 1 && grid[r][c-1] === val && grid[r][c-2] === val) return true;
    if(r > 1 && grid[r-1][c] === val && grid[r-2][c] === val) return true;
    return false;
}

/* ===== DIBUJAR ===== */
function render(){
    gridEl.innerHTML = "";
    for(let r=0; r<SIZE; r++){
        for(let c=0; c<SIZE; c++){
            const d = document.createElement("div");
            d.className = "cell";
            d.id = `cell-${r}-${c}`;
            d.textContent = grid[r][c] || "";
            d.onclick = () => clickCell(r, c);
            gridEl.appendChild(d);
        }
    }
}

/* ===== CLICK Y SWAP ===== */
function clickCell(r, c){
    if(isAnimating) return;

    const el = document.getElementById(`cell-${r}-${c}`);

    if(!selected){
        selected = {r, c, el};
        el.classList.add("selected");
        return;
    }

    const dist = Math.abs(selected.r - r) + Math.abs(selected.c - c);
    
    if(dist === 1){
        // Intercambio
        isAnimating = true;
        swap(selected.r, selected.c, r, c);
        
        if(findMatches().length > 0){
            selected.el.classList.remove("selected");
            selected = null;
            handleMatches();
        } else {
            // No hay match, deshacer
            setTimeout(() => {
                swap(selected.r, selected.c, r, c);
                selected.el.classList.remove("selected");
                selected = null;
                render();
                isAnimating = false;
            }, 300);
        }
    } else {
        // Seleccionar otro
        selected.el.classList.remove("selected");
        selected = {r, c, el};
        el.classList.add("selected");
    }
    render();
}

function swap(r1, c1, r2, c2){
    let temp = grid[r1][c1];
    grid[r1][c1] = grid[r2][c2];
    grid[r2][c2] = temp;
}

/* ===== L√ìGICA DE MATCHES ===== */
function findMatches(){
    let matches = [];
    // Horizontal
    for(let r=0; r<SIZE; r++){
        for(let c=0; c<SIZE-2; c++){
            let val = grid[r][c];
            if(val && val === grid[r][c+1] && val === grid[r][c+2]){
                matches.push({r, c}, {r, c+1}, {r, c+2});
            }
        }
    }
    // Vertical
    for(let c=0; c<SIZE; c++){
        for(let r=0; r<SIZE-2; r++){
            let val = grid[r][c];
            if(val && val === grid[r+1][c] && val === grid[r+2][c]){
                matches.push({r, c}, {r+1, c}, {r+2, c});
            }
        }
    }
    return matches;
}

async function handleMatches(){
    let matches = findMatches();
    if(matches.length === 0){
        isAnimating = false;
        checkEndLevel();
        return;
    }

    // Limpiar marcados
    matches.forEach(m => {
        if(grid[m.r][m.c]) {
            grid[m.r][m.c] = null;
            score += 10;
        }
    });

    document.getElementById("score-display").textContent = score;
    render();

    await new Promise(res => setTimeout(res, 300));

    // Ca√≠da
    for(let c=0; c<SIZE; c++){
        let emptySpaces = 0;
        for(let r=SIZE-1; r>=0; r--){
            if(grid[r][c] === null){
                emptySpaces++;
            } else if(emptySpaces > 0){
                grid[r + emptySpaces][c] = grid[r][c];
                grid[r][c] = null;
            }
        }
        // Rellenar arriba
        for(let r=0; r<emptySpaces; r++){
            grid[r][c] = animals[Math.floor(Math.random()*animals.length)];
        }
    }

    render();
    setTimeout(handleMatches, 300);
}

function checkEndLevel(){
    if(score >= target){
        if(level === unlocked && unlocked < 20){
            unlocked++;
            localStorage.setItem("animalpop_save", unlocked);
        }
        alert("¬°Nivel " + level + " superado!");
        goToMap();
    }
}

function goToMap(){
    selected = null;
    isAnimating = false;
    initMap();
}

initMap();
</script>

</body>
</html>
