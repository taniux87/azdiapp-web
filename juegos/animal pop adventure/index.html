<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AzDi Animal Pop | Edici√≥n Definitiva</title>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #06141b;
        --panel: #0d2230;
        --accent: #00e5ff;
        --pink: #ff2ea6;
        --candy-blue: #4facfe;
    }

    body {
        margin: 0;
        background: radial-gradient(circle at 30% 10%, #0b2a38, #02070a 70%);
        font-family: 'Segoe UI', sans-serif;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
    }

    #game-container {
        width: 450px;
        height: 800px;
        background: var(--panel);
        border-radius: 20px;
        box-shadow: 0 0 50px rgba(0, 229, 255, 0.3);
        overflow: hidden;
        position: relative;
        border: 3px solid var(--accent);
    }

    /* --- MAPA --- */
    #map-screen {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        overflow-y: auto;
        height: 100%;
        background: linear-gradient(to bottom, #1a4a6e, #06141b);
    }

    .level-node {
        width: 70px; height: 70px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        background: #123648;
        border: 4px solid var(--accent);
        cursor: pointer;
        font-family: 'Luckiest Guy', cursive;
        font-size: 26px;
        transition: 0.3s;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .level-node:hover:not(.locked) { transform: scale(1.1); background: var(--accent); color: #000; }
    .locked { opacity: .3; cursor: not-allowed; border-color: #555; filter: grayscale(1); }

    /* --- PANTALLA DE JUEGO --- */
    #game-screen { 
        display: none; 
        flex-direction: column; 
        height: 100%; 
        background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); 
    }

    .header {
        display: flex;
        justify-content: space-around;
        padding: 20px;
        background: rgba(0,0,0,0.5);
        font-family: 'Luckiest Guy', cursive;
        font-size: 20px;
        border-bottom: 3px solid white;
    }

    #grid {
        display: grid;
        grid-template-columns: repeat(8, 52px);
        grid-template-rows: repeat(8, 52px);
        gap: 5px;
        margin: auto;
        background: rgba(255,255,255,0.2);
        padding: 12px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .cell {
        width: 52px; height: 52px;
        background: rgba(255,255,255,0.3);
        display: flex; align-items: center; justify-content: center;
        font-size: 34px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.1s;
        user-select: none;
    }

    .cell.selected { outline: 4px solid var(--pink); background: rgba(255,46,166,0.4); transform: scale(1.1); z-index: 5; }

    .footer-ui {
        padding: 25px;
        text-align: center;
        background: rgba(0,0,0,0.3);
    }

    .btn {
        padding: 15px 40px;
        background: linear-gradient(90deg, #00e5ff, #ff2ea6);
        border: none;
        border-radius: 30px;
        color: white;
        font-family: 'Luckiest Guy', cursive;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
</style>
</head>
<body>

<div id="game-container">
    <div id="map-screen"></div>

    <div id="game-screen">
        <div class="header">
            <div id="level-txt">NIVEL 1</div>
            <div id="score-txt">PUNTOS: 0</div>
            <div id="target-txt">META: 500</div>
        </div>

        <div id="grid"></div>

        <div class="footer-ui">
            <div id="moves-txt" style="margin-bottom: 15px; font-family: 'Luckiest Guy'; font-size: 22px;">MOVES: 30</div>
            <button class="btn" onclick="goToMap()">SALIR</button>
        </div>
    </div>
</div>

<script>
const animals = ["üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº"];
const SIZE = 8;
let level = 1, score = 0, target = 0, moves = 30;
let unlocked = parseInt(localStorage.getItem("animal_pop_save") || 1);
let grid = [], selected = null, isProcessing = false;

const mapEl = document.getElementById("map-screen");
const gameEl = document.getElementById("game-screen");
const gridEl = document.getElementById("grid");

function initMap() {
    mapEl.innerHTML = "";
    mapEl.style.display = "grid";
    gameEl.style.display = "none";
    for (let i = 1; i <= 20; i++) {
        const n = document.createElement("div");
        n.className = "level-node " + (i > unlocked ? "locked" : "");
        n.textContent = i;
        n.onclick = () => { if (i <= unlocked) startLevel(i); };
        mapEl.appendChild(n);
    }
}

function startLevel(lvl) {
    level = lvl; score = 0; target = lvl * 600; moves = 35;
    document.getElementById("level-txt").textContent = "NIVEL " + lvl;
    document.getElementById("score-txt").textContent = "PUNTOS: 0";
    document.getElementById("target-txt").textContent = "META: " + target;
    document.getElementById("moves-txt").textContent = "MOVES: " + moves;
    
    mapEl.style.display = "none";
    gameEl.style.display = "flex";
    
    do { generateGrid(); } while (findMatches().length > 0);
    render();
}

function generateGrid() {
    grid = [];
    for (let r = 0; r < SIZE; r++) {
        grid[r] = [];
        for (let c = 0; c < SIZE; c++) {
            grid[r][c] = animals[Math.floor(Math.random() * animals.length)];
        }
    }
}

function render() {
    gridEl.innerHTML = "";
    for (let r = 0; r < SIZE; r++) {
        for (let c = 0; c < SIZE; c++) {
            const d = document.createElement("div");
            d.className = "cell";
            d.id = `cell-${r}-${c}`;
            d.textContent = grid[r][c] || "";
            d.onclick = () => clickCell(r, c);
            gridEl.appendChild(d);
        }
    }
}

async function clickCell(r, c) {
    if (isProcessing || moves <= 0) return;
    const el = document.getElementById(`cell-${r}-${c}`);

    if (!selected) {
        selected = { r, c, el };
        el.classList.add("selected");
    } else {
        const dist = Math.abs(selected.r - r) + Math.abs(selected.c - c);
        if (dist === 1) {
            isProcessing = true;
            selected.el.classList.remove("selected");
            swap(selected.r, selected.c, r, c);
            
            if (findMatches().length > 0) {
                moves--;
                document.getElementById("moves-txt").textContent = "MOVES: " + moves;
                selected = null;
                await handleSequence();
            } else {
                await new Promise(r => setTimeout(r, 200));
                swap(selected.r, selected.c, r, c);
                selected = null;
                render();
            }
            isProcessing = false;
        } else {
            selected.el.classList.remove("selected");
            selected = { r, c, el };
            el.classList.add("selected");
        }
    }
}

function swap(r1, c1, r2, c2) {
    let t = grid[r1][c1];
    grid[r1][c1] = grid[r2][c2];
    grid[r2][c2] = t;
    render();
}

function findMatches() {
    let m = [];
    for (let r = 0; r < SIZE; r++) {
        for (let c = 0; c < SIZE; c++) {
            let v = grid[r][c];
            if (!v) continue;
            if (c < SIZE - 2 && v === grid[r][c+1] && v === grid[r][c+2]) m.push({r,c},{r,c+1},{r,c+2});
            if (r < SIZE - 2 && v === grid[r+1][c] && v === grid[r+2][c]) m.push({r,c},{r+1,c},{r+2,c});
        }
    }
    return m;
}

async function handleSequence() {
    let matches = findMatches();
    if (matches.length === 0) { checkStatus(); return; }

    matches.forEach(pos => { if(grid[pos.r][pos.c]) { grid[pos.r][pos.c] = null; score += 15; } });
    document.getElementById("score-txt").textContent = "PUNTOS: " + score;
    render();
    await new Promise(res => setTimeout(res, 300));

    for (let c = 0; c < SIZE; c++) {
        let empty = 0;
        for (let r = SIZE - 1; r >= 0; r--) {
            if (!grid[r][c]) empty++;
            else if (empty > 0) { grid[r + empty][c] = grid[r][c]; grid[r][c] = null; }
        }
        for (let r = 0; r < empty; r++) grid[r][c] = animals[Math.floor(Math.random() * animals.length)];
    }
    render();
    await new Promise(res => setTimeout(res, 300));
    await handleSequence();
}

function checkStatus() {
    if (score >= target) {
        alert("¬°Nivel superado!");
        if (level === unlocked) { unlocked++; localStorage.setItem("animal_pop_save", unlocked); }
        goToMap();
    } else if (moves <= 0) {
        alert("Te has quedado sin movimientos.");
        goToMap();
    }
}

function goToMap() { initMap(); }
initMap();
</script>
</body>
</html>
