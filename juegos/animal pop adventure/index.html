<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzDi Animal Pop! Deluxe</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        :root { --pink: #ff66b2; --blue: #4facfe; --font: 'Luckiest Guy', cursive; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #222; font-family: var(--font); }
        
        #game-wrapper { width: 100%; max-width: 450px; height: 100%; margin: 0 auto; position: relative; background: #111; overflow: hidden; }

        /* --- UI TOP --- */
        .header-ui { position: absolute; top: 0; width: 100%; height: 80px; display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.5); z-index: 100; border-bottom: 3px solid var(--pink); }
        .stat-box { color: white; text-align: center; }
        .stat-label { font-size: 12px; color: var(--pink); display: block; }
        .stat-value { font-size: 20px; }

        /* --- MAPA --- */
        #map-screen { position: absolute; inset: 0; overflow-y: auto; background: linear-gradient(#4facfe, #00f2fe, #a8e063, #56ab2f); z-index: 10; padding-top: 80px; }
        .map-nodes { position: relative; width: 100%; height: 5000px; }
        .level-node { position: absolute; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; background: radial-gradient(circle, #f7a52e, #d47a00); border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.4); transform: translateX(-50%); cursor: pointer; transition: 0.2s; }
        .level-node.locked { background: #666; filter: grayscale(1); opacity: 0.7; }

        /* --- JUEGO --- */
        #game-screen { display: none; position: absolute; inset: 0; background: radial-gradient(#6ddaff, #2193b0); z-index: 50; flex-direction: column; justify-content: center; align-items: center; }
        #grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 95vw; max-width: 400px; aspect-ratio: 1/1; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 15px; border: 4px solid rgba(255,255,255,0.2); }
        
        .cell { background: rgba(255,255,255,0.15); border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; position: relative; transition: transform 0.2s, background 0.2s; }
        .cell.selected { background: white; transform: scale(1.1); z-index: 10; box-shadow: 0 0 15px white; }
        
        /* Efectos de Bombas */
        .cell.v-line::after { content: ''; position: absolute; width: 4px; height: 100%; background: white; box-shadow: 0 0 10px white; }
        .cell.h-line::after { content: ''; position: absolute; width: 100%; height: 4px; background: white; box-shadow: 0 0 10px white; }
        .cell.bomb-area { background: rgba(0,0,0,0.4); border: 2px solid #ff00ea; border-radius: 50%; }

        .footer-game { width: 100%; padding: 20px; display: flex; justify-content: space-around; align-items: center; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-family: var(--font); cursor: pointer; color: white; }
        
        /* Modal Retos */
        #challenge-modal { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; }
        .challenge-card { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; border: 5px solid var(--pink); }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div class="header-ui">
        <div class="stat-box">
            <span class="stat-label">VIDAS</span>
            <span class="stat-value">‚ù§Ô∏è <span id="val-lives">5</span></span>
        </div>
        <div class="stat-box">
            <span class="stat-label">MONEDAS</span>
            <span class="stat-value">üí∞ <span id="val-coins">100</span></span>
        </div>
        <button class="btn" style="background: #4caf50;" onclick="showAd()">üì∫ GRATIS</button>
    </div>

    <div id="map-screen">
        <div class="map-nodes" id="nodes-container"></div>
    </div>

    <div id="game-screen">
        <div style="margin-bottom: 20px; text-align: center; color: white;">
            <div style="font-size: 14px;">OBJETIVO: <span id="target-score">0</span></div>
            <div style="font-size: 32px;">PUNTOS: <span id="current-score">0</span></div>
        </div>
        
        <div id="grid"></div>

        <div class="footer-game">
            <div style="color: white; font-size: 24px;">MOV: <span id="val-moves">0</span></div>
            <button class="btn" style="background: #ff4d4d;" onclick="quitGame()">RENDIRSE</button>
        </div>
    </div>

    <div id="challenge-modal">
        <div class="challenge-card">
            <h2 id="ch-title" style="color: #333;">RETO</h2>
            <p id="ch-desc" style="color: #666;"></p>
            <button class="btn" style="background: var(--pink); font-size: 18px;" onclick="startChallenge()">¬°VAMOS!</button>
        </div>
    </div>
</div>

<script>
    const emojis = ['üê∂', 'üê±', 'üêπ', 'üê∞', 'ü¶ä', 'üêª'];
    let unlocked = parseInt(localStorage.getItem('azdi_unl')) || 1;
    let coins = parseInt(localStorage.getItem('azdi_coi')) || 100;
    let lives = parseInt(localStorage.getItem('azdi_liv')) || 5;

    let gridData = [];
    let selectedCell = null;
    let isWaiting = false;
    let gameMoves = 0, gameScore = 0, gameTarget = 0, currentLevel = 0;

    // --- SISTEMA DE MAPA ---
    function initMap() {
        const container = document.getElementById('nodes-container');
        container.innerHTML = '';
        const width = document.getElementById('game-wrapper').clientWidth;
        
        document.getElementById('val-lives').innerText = lives;
        document.getElementById('val-coins').innerText = coins;

        for (let i = 1; i <= 50; i++) {
            const node = document.createElement('div');
            node.className = `level-node ${i > unlocked ? 'locked' : ''}`;
            node.innerText = i;
            node.style.top = (4800 - (i * 130)) + 'px';
            node.style.left = (width/2 + Math.sin(i * 0.8) * (width * 0.25)) + 'px';
            if (i <= unlocked) node.onclick = () => checkLivesAndStart(i);
            container.appendChild(node);
        }
        document.getElementById('map-screen').scrollTop = 4800 - (unlocked * 130) - 300;
    }

    function checkLivesAndStart(lvl) {
        if (lives <= 0) return alert("¬°Sin vidas! Mira un video üì∫");
        
        // Probabilidad de Reto (25%)
        if (Math.random() < 0.25) {
            currentLevel = lvl;
            showChallengeScreen();
        } else {
            startGame(lvl);
        }
    }

    // --- L√ìGICA DE JUEGO ---
    function startGame(lvl) {
        currentLevel = lvl;
        gameScore = 0;
        gameMoves = Math.max(12, 25 - Math.floor(lvl / 2));
        gameTarget = 500 + (lvl * 400);
        
        document.getElementById('current-score').innerText = gameScore;
        document.getElementById('target-score').innerText = gameTarget;
        document.getElementById('val-moves').innerText = gameMoves;
        
        document.getElementById('map-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        
        createGrid();
    }

    function createGrid() {
        const gridEl = document.getElementById('grid');
        gridEl.innerHTML = '';
        gridData = [];
        for (let i = 0; i < 64; i++) {
            const animal = emojis[Math.floor(Math.random() * emojis.length)];
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.idx = i;
            cell.innerText = animal;
            cell.onclick = () => handleCellClick(cell);
            gridEl.appendChild(cell);
            gridData.push(animal);
        }
        // Limpiar matches iniciales
        while (instantCheck()) { /* Limpia en silencio */ }
    }

    function handleCellClick(cell) {
        if (isWaiting || gameMoves <= 0) return;

        if (!selectedCell) {
            selectedCell = cell;
            cell.classList.add('selected');
        } else {
            const idx1 = parseInt(selectedCell.dataset.idx);
            const idx2 = parseInt(cell.dataset.idx);

            if (isAdjacent(idx1, idx2)) {
                swapCells(idx1, idx2);
                isWaiting = true;
                
                setTimeout(() => {
                    if (!checkAndProcess()) {
                        // Si no hay match, deshacer (Igual que Candy Crush)
                        swapCells(idx1, idx2);
                        isWaiting = false;
                    } else {
                        gameMoves--;
                        document.getElementById('val-moves').innerText = gameMoves;
                    }
                }, 300);
            }
            selectedCell.classList.remove('selected');
            selectedCell = null;
        }
    }

    function isAdjacent(a, b) {
        const diff = Math.abs(a - b);
        const rowA = Math.floor(a / 8), rowB = Math.floor(b / 8);
        return (diff === 1 && rowA === rowB) || diff === 8;
    }

    function swapCells(i, j) {
        const temp = gridData[i];
        gridData[i] = gridData[j];
        gridData[j] = temp;
        updateView();
    }

    function updateView() {
        const cells = document.querySelectorAll('.cell');
        gridData.forEach((val, i) => {
            cells[i].innerText = val;
            // Limpiar clases de bombas si se vac√≠a
            if (!val) cells[i].className = 'cell';
        });
    }

    function checkAndProcess() {
        let matched = findMatches();
        if (matched.length > 0) {
            processMatched(matched);
            return true;
        }
        return false;
    }

    function findMatches() {
        let matchIds = new Set();
        // Horizontales
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 6; c++) {
                let i = r * 8 + c;
                if (gridData[i] && gridData[i] === gridData[i+1] && gridData[i] === gridData[i+2]) {
                    matchIds.add(i); matchIds.add(i+1); matchIds.add(i+2);
                }
            }
        }
        // Verticales
        for (let c = 0; c < 8; c++) {
            for (let r = 0; r < 6; r++) {
                let i = r * 8 + c;
                if (gridData[i] && gridData[i] === gridData[i+8] && gridData[i] === gridData[i+16]) {
                    matchIds.add(i); matchIds.add(i+8); matchIds.add(i+16);
                }
            }
        }
        return Array.from(matchIds);
    }

    function processMatched(matched) {
        gameScore += matched.length * 15;
        document.getElementById('current-score').innerText = gameScore;
        
        matched.forEach(id => {
            // Efecto Visual
            const cells = document.querySelectorAll('.cell');
            cells[id].style.transform = 'scale(0)';
            gridData[id] = null;
        });

        setTimeout(() => {
            dropItems();
        }, 300);
    }

    function dropItems() {
        for (let c = 0; c < 8; c++) {
            let emptySpaces = 0;
            for (let r = 7; r >= 0; r--) {
                let i = r * 8 + c;
                if (gridData[i] === null) {
                    emptySpaces++;
                } else if (emptySpaces > 0) {
                    gridData[i + (emptySpaces * 8)] = gridData[i];
                    gridData[i] = null;
                }
            }
            for (let r = 0; r < emptySpaces; r++) {
                gridData[r * 8 + c] = emojis[Math.floor(Math.random() * emojis.length)];
            }
        }
        updateView();
        const cells = document.querySelectorAll('.cell');
        cells.forEach(c => c.style.transform = 'scale(1)');

        setTimeout(() => {
            if (!checkAndProcess()) {
                isWaiting = false;
                checkWinLose();
            }
        }, 300);
    }

    function checkWinLose() {
        if (gameScore >= gameTarget) {
            unlocked = Math.max(unlocked, currentLevel + 1);
            coins += 25;
            saveData();
            alert("¬°NIVEL COMPLETADO! üç¨ +25üí∞");
            quitGame();
        } else if (gameMoves <= 0) {
            lives--;
            saveData();
            alert("No hay m√°s movimientos. ‚ùå -1 ‚ù§Ô∏è");
            quitGame();
        }
    }

    function instantCheck() {
        let m = findMatches();
        if (m.length > 0) {
            m.forEach(id => gridData[id] = emojis[Math.floor(Math.random() * emojis.length)]);
            return true;
        }
        return false;
    }

    // --- SISTEMA DE RETOS ---
    function showChallengeScreen() {
        const modal = document.getElementById('challenge-modal');
        const title = document.getElementById('ch-title');
        const desc = document.getElementById('ch-desc');
        
        const r = Math.random();
        if (r < 0.5) {
            title.innerText = "¬°RETO VELOZ!";
            desc.innerText = "Supera este nivel con 5 movimientos menos para ganar 50 monedas.";
            gameMoves -= 5;
        } else {
            title.innerText = "¬°MODO COLECCIONISTA!";
            desc.innerText = "La meta de puntos es m√°s alta, ¬°pero la recompensa es doble!";
            gameTarget = Math.floor(gameTarget * 1.5);
        }
        
        modal.style.display = 'flex';
    }

    function startChallenge() {
        document.getElementById('challenge-modal').style.display = 'none';
        startGame(currentLevel);
    }

    // --- UTILIDADES ---
    function quitGame() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('map-screen').style.display = 'block';
        initMap();
    }

    function showAd() {
        alert("Simulando Anuncio... üì∫");
        setTimeout(() => {
            lives = 5;
            coins += 50;
            saveData();
            initMap();
            alert("¬°Recompensa recibida! ‚ù§Ô∏è a tope y +50üí∞");
        }, 1000);
    }

    function saveData() {
        localStorage.setItem('azdi_unl', unlocked);
        localStorage.setItem('azdi_coi', coins);
        localStorage.setItem('azdi_liv', lives);
    }

    window.onload = initMap;
</script>
</body>
</html>
