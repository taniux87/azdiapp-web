<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AzDi Animal Pop! - Deluxe</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    
    <style>
        :root { --pink: #ff66b2; --blue: #4facfe; --gold: #ffd700; --font: 'Luckiest Guy', cursive; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #1a1a1a; font-family: var(--font); }
        #game-wrapper { width: 100%; max-width: 450px; height: 100%; margin: 0 auto; position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* --- UI TOP --- */
        .top-stats { position: absolute; top: 15px; left: 0; width: 100%; display: flex; justify-content: space-around; z-index: 110; pointer-events: none; }
        .stat-bubble { background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 25px; font-size: 16px; border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; gap: 8px; pointer-events: all; transition: transform 0.2s; }
        .stat-bubble:active { transform: scale(0.9); }
        .btn-ads { background: #4caf50; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: pulse 2s infinite; pointer-events: all; cursor: pointer; color: white; border-radius: 20px; padding: 5px 10px; }

        /* --- MAPA --- */
        #map-screen { position: absolute; inset: 0; overflow-y: auto; background: linear-gradient(#4facfe, #a8e063, #f7bb97); z-index: 10; scroll-behavior: smooth; }
        #map-topbar { position: sticky; top: 0; height: 60px; background: rgba(255, 102, 178, 0.9); display: flex; align-items: center; justify-content: center; color: white; z-index: 100; backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .map-nodes { position: relative; width: 100%; height: 5000px; padding-bottom: 100px; }
        .level-node { position: absolute; width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; background: radial-gradient(circle, #f7a52e, #d47a00); border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transform: translateX(-50%); cursor: pointer; z-index: 20; transition: 0.2s; }
        .level-node:active { transform: translateX(-50%) scale(0.9); }
        .level-node.locked { background: #666; filter: grayscale(1); cursor: default; }

        /* --- JUEGO --- */
        #game-screen { display: none; position: absolute; inset: 0; background: radial-gradient(#6ddaff, #2193b0); z-index: 150; flex-direction: column; }
        .game-header { background: rgba(0,0,0,0.2); padding: 50px 10px 10px; display: flex; justify-content: space-around; color: white; font-size: 18px; }
        #grid-container { margin: auto; display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; width: 95%; aspect-ratio: 1/1; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 15px; border: 3px solid rgba(255,255,255,0.4); }
        
        .cell { background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 32px; cursor: pointer; transition: transform 0.1s, background 0.2s; position: relative; }
        .cell:active { transform: scale(0.9); }
        .cell.selected { background: white; transform: scale(1.1); box-shadow: 0 0 15px white; z-index: 5; }
        .cell.special-line { background: #fff380; border: 2px solid gold; box-shadow: inset 0 0 10px orange; }
        .cell.special-bomb { background: #000; border: 2px solid #ff00ea; box-shadow: 0 0 15px #ff00ea; }

        /* --- PARTICULAS --- */
        .pop-effect { position: absolute; pointer-events: none; animation: popAnim 0.4s ease-out forwards; }
        @keyframes popAnim { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        #ad-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 300; color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div class="top-stats" id="ui-stats">
        <div class="stat-bubble" onclick="buyLife()">‚ù§Ô∏è <span id="val-lives">5</span> <small style="font-size:10px; background:green; padding:2px; border-radius:5px">COMPRAR</small></div>
        <div class="stat-bubble">üí∞ <span id="val-coins">0</span></div>
        <button class="btn-ads" onclick="showRewardAd()">üì∫+‚ù§Ô∏è</button>
    </div>

    <div id="ad-overlay">
        <h2 style="color:var(--gold)">VIDEO RECOMPENSA</h2>
        <div id="ad-timer" style="font-size: 60px; margin: 20px;">5</div>
        <p>Espera para recibir tus premios...</p>
    </div>

    <div id="map-screen">
        <div id="map-topbar">AZDI ANIMAL POP!</div>
        <div class="map-nodes" id="nodes-container"></div>
    </div>

    <div id="game-screen">
        <div class="game-header">
            <div>LVL <span id="cur-lvl">1</span></div>
            <div style="color:var(--gold)">OBJETIVO: <span id="target">500</span></div>
        </div>
        
        <div style="text-align: center; color: white; padding: 10px;">
            <div style="font-size: 24px;">PUNTOS: <span id="score">0</span></div>
        </div>

        <div id="grid-container"></div>

        <div style="margin-top:auto; padding: 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
            <div style="color: white; font-size: 30px;">üéà <span id="moves">25</span></div>
            <button onclick="closeGame()" style="background:#ff4d4d; border:none; padding:10px 20px; border-radius:15px; color:white; font-family:var(--font);">SALIR</button>
        </div>
    </div>
</div>

<script>
    const emojis = ['üê∂', 'üê±', 'üêπ', 'üê∞', 'ü¶ä', 'üêª'];
    const SPECIALS = { LINE: 'üß®', BOMB: 'üí£' };
    
    let unlocked = parseInt(localStorage.getItem('azdi_unlocked')) || 1;
    let coins = parseInt(localStorage.getItem('azdi_coins')) || 100;
    let lives = parseInt(localStorage.getItem('azdi_lives')) || 5;

    let selected = null, score = 0, moves = 30, goal = 500, currentLvl = 1, isProcessing = false;

    function updateUI() {
        document.getElementById('val-lives').textContent = lives;
        document.getElementById('val-coins').textContent = coins;
        localStorage.setItem('azdi_unlocked', unlocked);
        localStorage.setItem('azdi_coins', coins);
        localStorage.setItem('azdi_lives', lives);
    }

    function buyLife() {
        if (coins >= 50) {
            coins -= 50;
            lives++;
            alert("¬°Has comprado 1 Vida! ‚ù§Ô∏è");
            updateUI();
        } else {
            alert("No tienes suficientes monedas (50üí∞)");
        }
    }

    function showRewardAd() {
        const overlay = document.getElementById('ad-overlay');
        overlay.style.display = 'flex';
        let count = 5;
        const interval = setInterval(() => {
            count--;
            document.getElementById('ad-timer').textContent = count;
            if (count <= 0) {
                clearInterval(interval);
                overlay.style.display = 'none';
                lives += 2; coins += 25;
                updateUI();
                alert("¬°Recompensa recibida! +2‚ù§Ô∏è +25üí∞");
            }
        }, 1000);
    }

    function drawMap() {
        updateUI();
        const container = document.getElementById('nodes-container');
        container.innerHTML = '';
        const w = document.getElementById('game-wrapper').clientWidth;

        for (let i = 1; i <= 50; i++) {
            const div = document.createElement('div');
            div.className = `level-node ${i > unlocked ? 'locked' : ''}`;
            div.innerHTML = i;
            div.style.top = (4800 - (i * 120)) + 'px';
            div.style.left = (w/2 + Math.sin(i * 0.7) * (w * 0.25)) + 'px';
            if (i <= unlocked) div.onclick = () => (lives > 0) ? launchLevel(i) : alert("¬°Sin vidas!");
            container.appendChild(div);
        }
        document.getElementById('map-screen').scrollTop = 4800 - (unlocked * 120) - 300;
    }

    function launchLevel(lvl) {
        currentLvl = lvl; score = 0; isProcessing = false;
        moves = Math.max(15, 30 - Math.floor(lvl/3));
        goal = 500 + (lvl * 300);
        document.getElementById('cur-lvl').textContent = lvl;
        document.getElementById('score').textContent = score;
        document.getElementById('target').textContent = goal;
        document.getElementById('moves').textContent = moves;
        document.getElementById('map-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        initGrid();
    }

    function initGrid() {
        const grid = document.getElementById('grid-container');
        grid.innerHTML = '';
        for (let i = 0; i < 64; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.id = i;
            cell.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            cell.onclick = () => onCellClick(cell);
            grid.appendChild(cell);
        }
        // Limpiar matches iniciales sin gastar movimientos
        checkMatchesSilently();
    }

    function onCellClick(cell) {
        if (isProcessing || moves <= 0) return;

        if (!selected) {
            selected = cell;
            cell.classList.add('selected');
        } else {
            const id1 = parseInt(selected.dataset.id);
            const id2 = parseInt(cell.dataset.id);

            if (isAdjacent(id1, id2)) {
                swap(selected, cell);
                moves--;
                document.getElementById('moves').textContent = moves;
                isProcessing = true;
                setTimeout(() => {
                    if (!processMatches()) {
                        swap(selected, cell); // Deshacer si no hay match
                        isProcessing = false;
                    }
                }, 300);
            }
            selected.classList.remove('selected');
            selected = null;
        }
    }

    function isAdjacent(a, b) {
        const diff = Math.abs(a - b);
        return (diff === 1 && Math.floor(a/8) === Math.floor(b/8)) || diff === 8;
    }

    function swap(a, b) {
        const t = a.textContent;
        const tc = a.className;
        a.textContent = b.textContent;
        a.className = b.className;
        b.textContent = t;
        b.className = tc;
        a.classList.remove('selected');
        b.classList.remove('selected');
    }

    function processMatches() {
        const cells = document.querySelectorAll('.cell');
        let matched = new Set();
        let specialToCreate = null;

        // Buscar horizontales
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 6; c++) {
                let idx = r * 8 + c;
                let char = cells[idx].textContent;
                if (char && char === cells[idx+1].textContent && char === cells[idx+2].textContent) {
                    matched.add(idx); matched.add(idx+1); matched.add(idx+2);
                    if (c < 5 && char === cells[idx+3].textContent) { 
                        matched.add(idx+3); 
                        specialToCreate = { id: idx, type: 'special-line', emoji: SPECIALS.LINE };
                    }
                }
            }
        }

        // Buscar verticales
        for (let c = 0; c < 8; c++) {
            for (let r = 0; r < 6; r++) {
                let idx = r * 8 + c;
                let char = cells[idx].textContent;
                if (char && char === cells[idx+8].textContent && char === cells[idx+16].textContent) {
                    matched.add(idx); matched.add(idx+8); matched.add(idx+16);
                    if (r < 4 && char === cells[idx+24].textContent) {
                        matched.add(idx+24);
                        specialToCreate = { id: idx, type: 'special-bomb', emoji: SPECIALS.BOMB };
                    }
                }
            }
        }

        if (matched.size > 0) {
            score += matched.size * 10;
            document.getElementById('score').textContent = score;

            matched.forEach(i => {
                // Si explota una bomba
                if (cells[i].textContent === SPECIALS.LINE) score += 50; 
                if (cells[i].textContent === SPECIALS.BOMB) score += 100;
                
                cells[i].textContent = '';
                cells[i].className = 'cell';
            });

            if (specialToCreate) {
                cells[specialToCreate.id].textContent = specialToCreate.emoji;
                cells[specialToCreate.id].classList.add(specialToCreate.type);
            }

            setTimeout(drop, 300);
            return true;
        } else {
            checkGameOver();
            isProcessing = false;
            return false;
        }
    }

    function drop() {
        const cells = document.querySelectorAll('.cell');
        for (let c = 0; c < 8; c++) {
            for (let r = 7; r >= 0; r--) {
                const i = r * 8 + c;
                if (cells[i].textContent === '') {
                    let top = r - 1;
                    while (top >= 0 && cells[top * 8 + c].textContent === '') top--;
                    if (top >= 0) {
                        cells[i].textContent = cells[top * 8 + c].textContent;
                        cells[i].className = cells[top * 8 + c].className;
                        cells[top * 8 + c].textContent = '';
                        cells[top * 8 + c].className = 'cell';
                    } else {
                        cells[i].textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    }
                }
            }
        }
        setTimeout(processMatches, 300);
    }

    function checkGameOver() {
        if (score >= goal) {
            coins += (20 + currentLvl);
            alert("¬°EXCELENTE! üéâ Nivel superado.");
            if (currentLvl === unlocked) unlocked++;
            closeGame();
        } else if (moves <= 0) {
            lives--;
            alert("Te has quedado sin movimientos... üò¢");
            closeGame();
        }
    }

    function checkMatchesSilently() {
        // Limpieza r√°pida inicial
        const cells = document.querySelectorAll('.cell');
        let hasMatch = false;
        for (let i = 0; i < 64; i++) {
            // L√≥gica simplificada solo para rellenar huecos iniciales sin repetir
            if (i % 8 < 6 && cells[i].textContent === cells[i+1].textContent && cells[i].textContent === cells[i+2].textContent) {
                cells[i].textContent = emojis[Math.floor(Math.random() * emojis.length)];
                hasMatch = true;
            }
        }
        if (hasMatch) checkMatchesSilently();
    }

    function closeGame() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('map-screen').style.display = 'block';
        drawMap();
    }

    window.onload = drawMap;
</script>
</body>
</html>
