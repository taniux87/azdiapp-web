<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Animal Saga: Extreme Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink: #ff1493; --blue: #00d2ff; --purple: #9d50bb;
            --gold: #ffcc33; --font: 'Luckiest Guy', cursive;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: #0f0c29; font-family: var(--font);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        /* --- CONTENEDOR TIPO APP --- */
        #game-container {
            width: 100%; max-width: 480px; height: 100%;
            background: linear-gradient(to bottom, #24243e, #302b63, #0f0c29);
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        /* --- HEADER --- */
        .header {
            height: 90px; display: flex; justify-content: space-around; align-items: center;
            background: rgba(0,0,0,0.4); border-bottom: 4px solid var(--pink);
            padding: 0 10px; z-index: 10;
        }

        .stat-box { text-align: center; color: white; min-width: 80px; }
        .stat-label { font-size: 12px; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 24px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* --- PUNTUACI√ìN --- */
        .score-bar {
            padding: 20px 10px; text-align: center; color: white;
        }
        .score-bar h2 { font-size: 50px; margin: 0; color: var(--gold); text-shadow: 0 0 20px rgba(255,204,51,0.5); }
        .target-text { font-size: 14px; opacity: 0.8; letter-spacing: 2px; }

        /* --- TABLERO --- */
        #board-area {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            padding: 10px; perspective: 1000px;
        }

        #grid {
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px;
            width: 100%; aspect-ratio: 1/1; 
            background: rgba(255,255,255,0.05); padding: 10px;
            border-radius: 25px; border: 6px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            position: relative;
        }

        /* --- PIEZAS --- */
        .cell {
            aspect-ratio: 1/1; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 34px; position: relative; cursor: pointer;
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(255,255,255,0.03);
        }

        .cell.active { transform: scale(1.2); z-index: 100; background: rgba(255,255,255,0.2) !important; box-shadow: 0 0 20px white; }

        /* ESPECIALES VISUALES */
        .s-row::before { content: ''; position: absolute; width: 100%; height: 10px; background: white; border-radius: 20px; box-shadow: 0 0 15px white; }
        .s-col::before { content: ''; position: absolute; width: 10px; height: 100%; background: white; border-radius: 20px; box-shadow: 0 0 15px white; }
        .s-bomb { background: radial-gradient(circle, var(--gold), transparent) !important; animation: pulse 0.6s infinite alternate; }
        .s-hyper { animation: rotate 2s infinite linear; font-size: 45px !important; filter: drop-shadow(0 0 15px white); }

        @keyframes pulse { from { transform: scale(0.9); } to { transform: scale(1.1); } }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- PARTICULAS --- */
        .particle {
            position: absolute; pointer-events: none; border-radius: 50%;
            z-index: 1000; animation: particleOut 0.6s forwards;
        }
        @keyframes particleOut {
            to { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
        }

        /* --- MODALES --- */
        .modal {
            display: none; position: absolute; inset: 0;
            background: rgba(0,0,0,0.85); z-index: 2000;
            align-items: center; justify-content: center;
        }

        .modal-content {
            background: white; width: 85%; padding: 40px 20px;
            border-radius: 40px; border: 10px solid var(--pink);
            text-align: center; transform: translateY(100px); opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal.show .modal-content { transform: translateY(0); opacity: 1; }

        .btn-big {
            background: #4caf50; color: white; padding: 18px 45px;
            border-radius: 50px; border: none; font-family: var(--font);
            font-size: 28px; cursor: pointer; margin-top: 25px;
            box-shadow: 0 8px 0 #2e7d32; transition: 0.1s;
        }

        .btn-big:active { transform: translateY(4px); box-shadow: 0 4px 0 #2e7d32; }

        /* --- FOOTER --- */
        .footer {
            height: 120px; display: flex; justify-content: center; align-items: center;
            padding-bottom: 20px;
        }
        .moves-circle {
            width: 90px; height: 90px; border-radius: 50%;
            background: var(--pink); border: 5px solid white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        /* ===== BOSQUE ===== */
.forest{
    position:absolute;
    inset:0;
    z-index:0;
    background:
    radial-gradient(circle at 20% 80%, #1b5e20 0%, transparent 40%),
    radial-gradient(circle at 80% 85%, #2e7d32 0%, transparent 40%),
    radial-gradient(circle at 50% 90%, #33691e 0%, transparent 50%),
    linear-gradient(#0d1b0f,#071109);
    animation:forestMove 10s infinite alternate ease-in-out;
    border-radius:25px;
}

@keyframes forestMove{
    from{filter:brightness(0.9) hue-rotate(0deg)}
    to{filter:brightness(1.2) hue-rotate(10deg)}
}

#grid{ position:relative; z-index:1; }

/* ===== BOTON DETONAR ===== */
.detonate{
    position:absolute;
    bottom:10px;
    right:10px;
    z-index:20;
    background:#ff1744;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:20px;
    font-family:var(--font);
    box-shadow:0 5px 0 #b71c1c;
}

/* ===== BLOQUES ===== */
.block{
    background:#6d4c41 !important;
    box-shadow: inset 0 0 15px black;
}

.jelly{
    background: radial-gradient(circle, rgba(255,255,255,0.35), transparent);
}

.wrapped{
    outline:4px solid #fff176;
    box-shadow:0 0 20px #ffee58;
}
    </style>
</head>
<body>

<div id="game-container">
    <div class="header">
        <div class="stat-box">
            <div class="stat-label">Vidas</div>
            <div class="stat-val">‚ù§Ô∏è 5</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Monedas</div>
            <div class="stat-val" style="color:var(--gold)">üí∞ <span id="coins">100</span></div>
        </div>
        <button onclick="location.reload()" style="background:none; border:2px solid white; color:white; border-radius:10px; font-family:var(--font); padding:5px 10px;">RESET</button>
    </div>

    <div class="score-bar">
        <div class="target-text">OBJETIVO: <span id="target">1200</span></div>
        <h2 id="score">0</h2>
    </div>

    <div id="board-area">
    <div class="forest"></div>
    <div id="grid"></div>

    <button id="detonateBtn" class="detonate">üí£ DETONAR</button>
</div>
    <div class="footer">
        <div class="moves-circle">
            <div style="font-size:12px">MOVS</div>
            <div id="moves" style="font-size:32px">25</div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h1 style="color:var(--pink); font-size:50px; margin:0;">¬°INCRE√çBLE!</h1>
            <div style="font-size:60px; margin:20px 0;">‚≠ê‚≠ê‚≠ê</div>
            <p style="font-size:24px; color:#333;">NIVEL COMPLETADO</p>
            <button class="btn-big" onclick="nextLevel()">CONTINUAR</button>
        </div>
    </div>
</div>

<script>
/**
 * MOTOR DE JUEGO "GOLIATH"
 * Dise√±ado para Tania - Clon Pro Candy Crush
 */

const ANIMALS = ['üê∂', 'üê±', 'üêπ', 'üê∞', 'ü¶ä', 'üêª'];
const HYPER = 'üåà';

let state = {
    grid: [],
    specials: [], // null, 'row', 'col', 'bomb', 'hyper'
    score: 0,
    moves: 25,
    target: 1200,
    isLocked: false,
    selected: null
};
// --- NUEVAS CAPAS DE JUEGO ---
state.jelly = new Array(64).fill(false);
state.blocks = new Array(64).fill(false);
state.inventoryBombs = [];
// --- AUDIO (Sintetizado para evitar dependencias externas que fallen) ---
const playSfx = (freq, type = 'sine', duration = 0.1) => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + duration);
};

// --- INICIALIZACI√ìN ---
function init() {
    const gridEl = document.getElementById('grid');
    gridEl.innerHTML = '';
    state.grid = [];
    state.specials = [];
    state.jelly.fill(false);
state.blocks.fill(false);
state.inventoryBombs=[];
    state.score = 0;
    state.moves = 25;

    for (let i = 0; i < 64; i++) {
        state.grid.push(ANIMALS[Math.floor(Math.random() * ANIMALS.length)]);
        state.specials.push(null);
        const div = document.createElement('div');
        div.className = 'cell';
        div.dataset.idx = i;
        div.onclick = () => onCellClick(i);
        gridEl.appendChild(div);
    }

    // Limpiar matches iniciales
    while (findMatches().length > 0) {
        findMatches().forEach(m => state.grid[m] = ANIMALS[Math.floor(Math.random() * ANIMALS.length)]);
    }
    // Generar gelatina
for(let i=0;i<64;i++){
    if(Math.random()<0.35) state.jelly[i]=true;
}

// Generar bloques madera
for(let i=0;i<64;i++){
    if(Math.random()<0.08){
        state.blocks[i]=true;
        state.grid[i]=null;
    }
}
    render();
}

// --- L√ìGICA DE CLICK ---
async function onCellClick(idx) {
    if (state.isLocked || state.moves <= 0) return;

    if (state.selected === null) {
        state.selected = idx;
        document.querySelectorAll('.cell')[idx].classList.add('active');
        playSfx(440, 'sine', 0.05);
    } else {
        const i = state.selected;
        const j = idx;
        document.querySelectorAll('.cell')[i].classList.remove('active');
        state.selected = null;

        if (isAdjacent(i, j)) {
            state.isLocked = true;
            await swap(i, j);

            let matches = findMatches();
            
            // Especial: Mezcla con Hiper-Arco√≠ris
            if (state.grid[i] === HYPER || state.grid[j] === HYPER) {
                const colorIdx = state.grid[i] === HYPER ? j : i;
                const hyperIdx = state.grid[i] === HYPER ? i : j;
                matches = activateHyper(state.grid[colorIdx]);
                matches.push(hyperIdx);
            }

            if (matches.length > 0) {
                state.moves--;
                await handleMatches(matches);
            } else {
                await swap(i, j); // Retroceso
            }
            state.isLocked = false;
            checkEnd();
        }
    }
}

// --- GESTI√ìN DE MATCHES Y COMBOS ---
async function handleMatches(matches) {
async function handleMatches(matches) {

    let toDestroy = new Set(matches);

    // CREAR ESPECIALES
    if(matches.length===4){
        state.specials[matches[0]]='row';
    }
    else if(matches.length===5){
        state.specials[matches[0]]='wrapped';
    }
    else if(matches.length>=6){
        state.grid[matches[0]]=HYPER;
        state.specials[matches[0]]='hyper';
    }

    // ACTIVAR ESPECIALES
    matches.forEach(m => {

        if(state.specials[m]==='wrapped'){
            state.inventoryBombs.push(m);
        }

        if (state.specials[m] === 'row') explodeRow(Math.floor(m/8), toDestroy);
        if (state.specials[m] === 'col') explodeCol(m%8, toDestroy);
        if (state.specials[m] === 'wrapped') explodeArea(m, toDestroy);
    });

    // PUNTUACION
    state.score += toDestroy.size * 25;
    updateUI();
    playSfx(200 + (toDestroy.size * 10), 'triangle', 0.2);
    shakeBoard();

    // DESTRUIR
    toDestroy.forEach(idx => {
        createParticles(idx);

        if(state.jelly[idx]) state.jelly[idx]=false;
        if(state.blocks[idx]) state.blocks[idx]=false;

        state.grid[idx] = null;
        state.specials[idx] = null;
    });

    render();
    await wait(400);
    await fillCascada();
}
// --- SISTEMA DE CASCADA (EL CORAZ√ìN) ---
async function fillCascada() {
    for (let c = 0; c < 8; c++) {
        let holes = 0;
        for (let r = 7; r >= 0; r--) {
            let i = r * 8 + c;
            if (state.grid[i] === null) holes++;
            else if (holes > 0) {
                state.grid[i + (holes * 8)] = state.grid[i];
                state.specials[i + (holes * 8)] = state.specials[i];
                state.grid[i] = null;
                state.specials[i] = null;
            }
        }
        for (let r = 0; r < holes; r++) {
            state.grid[r * 8 + c] = ANIMALS[Math.floor(Math.random() * ANIMALS.length)];
        }
    }
    render();
    
    let comboMatches = findMatches();
    if (comboMatches.length > 0) {
        await wait(300);
        await handleMatches(comboMatches);
    }
}

// --- BUSCADOR DE MATCHES ---
function findMatches() {
    let m = new Set();
    // Horizontales
    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 6; c++) {
            let i = r * 8 + c;
            if (state.grid[i] && state.grid[i] === state.grid[i+1] && state.grid[i] === state.grid[i+2]) {
                m.add(i); m.add(i+1); m.add(i+2);
            }
        }
    }
    // Verticales
    for (let c = 0; c < 8; c++) {
        for (let r = 0; r < 6; r++) {
            let i = r * 8 + c;
            if (state.grid[i] && state.grid[i] === state.grid[i+8] && state.grid[i] === state.grid[i+16]) {
                m.add(i); m.add(i+8); m.add(i+16);
            }
        }
    }
    return Array.from(m);
}

// --- FUNCIONES DE EXPLOSI√ìN ---
function explodeRow(r, set) { for(let i=0; i<8; i++) set.add(r*8+i); playSfx(150, 'square', 0.3); }
function explodeCol(c, set) { for(let i=0; i<8; i++) set.add(i*8+c); playSfx(150, 'square', 0.3); }
function explodeArea(idx, set) {
    let r = Math.floor(idx/8), c = idx%8;
    for(let i=r-1; i<=r+1; i++) {
        for(let j=c-1; j<=c+1; j++) {
            if(i>=0 && i<8 && j>=0 && j<8) set.add(i*8+j);
        }
    }
}
function activateHyper(emoji) {
    return state.grid.map((v, i) => v === emoji ? i : -1).filter(i => i !== -1);
}

// --- UI Y RENDER ---
function render(){
const cells=document.querySelectorAll('.cell');

state.grid.forEach((v,i)=>{
    cells[i].innerText=v||'';
    cells[i].className='cell';

    if(state.blocks[i]) cells[i].classList.add('block');
    if(state.jelly[i]) cells[i].classList.add('jelly');

    if(state.specials[i]==='row') cells[i].classList.add('s-row');
    if(state.specials[i]==='col') cells[i].classList.add('s-col');
    if(state.specials[i]==='wrapped') cells[i].classList.add('wrapped');
    if(state.specials[i]==='hyper') cells[i].classList.add('s-hyper');

    cells[i].style.opacity=v||state.blocks[i]?1:0;
});
}

function updateUI() {
    document.getElementById('score').innerText = state.score;
    document.getElementById('moves').innerText = state.moves;
}

function createParticles(idx) {
    const cell = document.querySelectorAll('.cell')[idx];
    const rect = cell.getBoundingClientRect();
    for (let i = 0; i < 6; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (rect.left + 20) + 'px';
        p.style.top = (rect.top + 20) + 'px';
        p.style.width = '10px'; p.style.height = '10px';
        p.style.background = ['#ff1493','#00d2ff','#ffcc33'][Math.floor(Math.random()*3)];
        p.style.setProperty('--x', (Math.random()*100 - 50) + 'px');
        p.style.setProperty('--y', (Math.random()*100 - 50) + 'px');
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 600);
    }
}

function shakeBoard() {
    const b = document.getElementById('grid');
    b.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
    setTimeout(() => b.style.transform = 'translate(0,0)', 100);
}

function checkEnd() {
    if (state.score >= state.target) {
        const m = document.getElementById('modal');
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('show'), 10);
        playSfx(523, 'sine', 0.5);
    } else if (state.moves <= 0) {
        alert("GAME OVER üò¢");
        init();
    }
}

// --- UTILS ---
function isAdjacent(a,b){
    if(state.blocks[a] || state.blocks[b]) return false;
    return Math.abs(Math.floor(a/8)-Math.floor(b/8)) + Math.abs((a%8)-(b%8))===1;
}
async function swap(i, j) {
    [state.grid[i], state.grid[j]] = [state.grid[j], state.grid[i]];
    [state.specials[i], state.specials[j]] = [state.specials[j], state.specials[i]];
    render();
    await wait(200);
}
function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
function nextLevel() {
    document.getElementById('modal').classList.remove('show');
    setTimeout(() => {
        document.getElementById('modal').style.display = 'none';
        state.target += 500;
        document.getElementById('target').innerText = state.target;
        init();
    }, 500);
}
window.onload = ()=>{
    init();

    document.getElementById('detonateBtn').onclick=async ()=>{
        if(state.inventoryBombs.length===0) return;

        state.isLocked=true;

        let toDestroy=new Set();

        state.inventoryBombs.forEach(idx=>{
            explodeArea(idx,toDestroy);
            explodeRow(Math.floor(idx/8),toDestroy);
            explodeCol(idx%8,toDestroy);
        });

        state.inventoryBombs=[];

        await handleMatches([...toDestroy]);
        state.isLocked=false;
    };
};
</script>
</body>
</html>
